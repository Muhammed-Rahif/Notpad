name: Greet, Celebrate, and Encourage

on:
  issues:
    types:
      - opened
      - assigned
  pull_request:
    types:
      - opened
  pull_request_target:
    types:
      - closed

jobs:
  greet:
    name: Greet, Celebrate, and Encourage
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Check User Contributions
        id: check_contributions
        uses: actions/github-script@v7
        with:
          script: |
            const user = context.payload.sender.login;
            const [userIssues, userPulls] = await Promise.all([
              github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                creator: user,
                state: 'all'
              }),
              github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                creator: user
              })
            ]);

            const totalContributions = userIssues.data.length + userPulls.data.length;

            console.log(`User: ${user}, Issues: ${userIssues.length}, PRs: ${userPulls.length}, Total: ${totalContributions}`);
            core.setOutput('isFirstTime', totalContributions === 1);
            core.setOutput('totalContributions', totalContributions);

      - name: Post Personalized Greeting
        if: ${{ github.event.action == 'opened' }}
        uses: actions/github-script@v7
        with:
          script: |
            const user = context.payload.sender.login;
            const isIssue = !!context.payload.issue;
            const isPR = !!context.payload.pull_request;
            const isFirstTime = '${{ steps.check_contributions.outputs.isFirstTime }}' === 'true';
            const totalContributions = parseInt('${{ steps.check_contributions.outputs.totalContributions }}');
            let message = '';

            if (isFirstTime) {
              message = `ðŸŽ‰ Welcome aboard, @${user}! ðŸš€  
              We're excited to see your **first contribution** to **Notpad**! ðŸŒŸ  
              Every great project starts with contributors like you. ðŸ’¡  
              Take a moment to check out our [CONTRIBUTING.md](https://github.com/Muhammed-Rahif/Notpad/blob/main/CONTRIBUTING.md) for tips and guidelines.  
              Feel free to explore, experiment, and engage with the community.  
              Your journey in open source starts here â€“ happy coding! ðŸ–¥ï¸`;
            }

            if (isIssue) {
              message += `  
              ðŸ‘‹ Hi @${user}! Thank you for taking the time to report an issue in **Notpad**.  
              Weâ€™ll dive into it shortly. ðŸ•µï¸â€â™‚ï¸ðŸ”§  
              While you're here, why not add a â­ to the repo? [Click here to star](https://github.com/Muhammed-Rahif/Notpad/stargazers).  
              Your support helps us grow this project and reach more awesome contributors like you! ðŸš€`;
            }

            if (isPR) {
              message += `  
              ðŸ™Œ Woohoo, @${user}! Thanks for opening a pull request to **Notpad**. ðŸ› ï¸âœ¨  
              Your efforts make this project better with every contribution.  
              ðŸ’¡ Before we merge this, donâ€™t forget to check our [CONTRIBUTING.md](https://github.com/Muhammed-Rahif/Notpad/blob/main/CONTRIBUTING.md) for a smoother process.  
              Together, weâ€™re building something incredible â€“ keep up the amazing work! ðŸ’ª  
              (Psst... have you starred the repo yet? â­)`;
            }

            if (totalContributions === 5) {
              message += `  
              ðŸŽŠ High five, @${user}! âœ‹ Youâ€™ve just hit a major milestone â€“ **5 contributions** to **Notpad**!  
              Contributors like you make this project shine brighter every day. ðŸŒŸ  
              Your dedication inspires us, and we canâ€™t wait to see what you come up with next.  
              A big thank you from the entire **Notpad** team â€“ we deeply appreciate your support. ðŸ™  
              Letâ€™s keep building and making open source awesome together! ðŸš€`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue?.number || context.payload.pull_request?.number,
              body: message
            });

      - name: Assign User Guidance
        if: ${{ github.event.action == 'assigned' }}
        uses: actions/github-script@v7
        with:
          script: |
            const assignee = context.payload.assignee.login;
            const issueNumber = context.payload.issue.number;

            // Fetch issues and pull requests created by the assignee
            const [issues, pulls] = await Promise.all([
              github.paginate(github.rest.issues.listForRepo, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
              }),
              github.paginate(github.rest.pulls.list, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
              }),
            ]);

            // Filter to count only issues and pull requests created by the assignee
            const assigneeIssues = issues.filter(issue => issue.user.login === assignee);
            const assigneePulls = pulls.filter(pr => pr.user.login === assignee);

            const totalContributions = assigneeIssues.length + assigneePulls.length;

            // Log total contributions for debugging

            // Compose the message based on contribution count
            let message = '';
            if (totalContributions < 3) {
              message = `ðŸ› ï¸ **Heads up, @${assignee}!**  
              You've been assigned an issue in **Notpad** â€“ ready to make your mark? ðŸš€  
              Since you're relatively new here, we highly recommend checking out our [CONTRIBUTING.md](https://github.com/Muhammed-Rahif/Notpad/blob/main/CONTRIBUTING.md).  
              Itâ€™s packed with helpful tips, guidelines, and best practices to ensure a smooth contribution experience.  
              Weâ€™re excited to see what youâ€™ll bring to the table â€“ happy coding! ðŸ’»âœ¨`;
            } else {
              message = `ðŸŽ‰ Hi @${assignee}! You've been assigned an issue in **Notpad**.  
              Your contributions so far have been awesome, and we can't wait to see what you'll do next! ðŸš€  
              Remember to check out our [CONTRIBUTING.md](https://github.com/Muhammed-Rahif/Notpad/blob/main/CONTRIBUTING.md) for any guidelines or tips.  
              Let's build something great together! ðŸ’¡`;
            }

            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: message
            });

      - name: Assign User Guidance
        if: ${{ github.event.action == 'assigned' && steps.check_contributions.outputs.totalContributions < 3 }}
        uses: actions/github-script@v7
        with:
          script: |
            const assignee = context.payload.assignee.login;
            const issueNumber = context.payload.issue.number;
            const message = `ðŸ› ï¸ **Heads up, @${assignee}!**  
            You've been assigned an issue in **Notpad** â€“ ready to make your mark? ðŸš€  
            Since you're relatively new here, we highly recommend checking out our [CONTRIBUTING.md](https://github.com/Muhammed-Rahif/Notpad/blob/main/CONTRIBUTING.md).  
            Itâ€™s packed with helpful tips, guidelines, and best practices to ensure a smooth contribution experience.  
            Weâ€™re excited to see what youâ€™ll bring to the table â€“ happy coding! ðŸ’»âœ¨`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: message
            });

      - name: Thank Contributor When PR is Merged
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const message = `ðŸŽ‰ Congratulations, @${pr.user.login}! Your pull request has been successfully merged. ðŸ¥³ðŸŽˆ  
            Youâ€™ve just made **Notpad** better, and we couldnâ€™t be more thankful. ðŸ™Œ  
            Your contribution is now part of the project, helping users and contributors around the world. ðŸŒ  
            Weâ€™re excited to see what else you have in store for us â€“ the best is yet to come! ðŸ’¡  
            Cheers to you and the amazing world of open source! ðŸ»âœ¨`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: message
            });
